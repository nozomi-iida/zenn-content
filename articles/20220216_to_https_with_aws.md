---
title: "httpで公開したWebサーバーをhttps通信できるようにする"
emoji: "📝"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [aws, ec2, https, tls]
published: true
---

[前回の記事](https://zenn.dev/nozomi_iida/articles/20220213_to_dns_with_aws)で、AWS の EC2 で Web サーバーを立てて、http 通信で公開する方法を紹介しました。
今回は前回の構成を使用して、https 通信で公開する方法を紹介します。
インフラの構成は以下のようになります。
![](https://storage.googleapis.com/zenn-user-upload/f6726d6d264c-20230224.png)

## ACM を使用して TLS 証明書を発行する

ACM とは、AWS が提供する TLS 証明書の管理サービスです。
TLS 証明書とは、サーバーとクライアントが通信を行う際に、通信の暗号化を行うための証明書です。
SSL 証明書ともいいます。
TLS 証明書の仕組みについてはこちらの記事を読んでみるとイメージしやすくて良いと思います。
@[card](https://wa3.i-3-i.info/word1836.html)

![](https://storage.googleapis.com/zenn-user-upload/477611b44e4e-20230224.png)
作成する時の注意点なのですが、ドメイン名を入力する際にワイルドカードドメインを使用すると、サブドメインも含めて証明書が発行されます。
例えば`*.example.com`と入力すると、`example.com`と`www.example.com`の両方に対して証明書が発行されます。

### ターゲットグループの作成

ターゲットグループとは、ロードバランサーがリクエストを転送する先の EC2 インスタンスを指定するためのグループです。
この後のロードバランサーを作成する際に必要なので今作っておきます
![](https://storage.googleapis.com/zenn-user-upload/35b9a946381a-20230301.png)

ロードバラーンサーを入れるためのパブリックサブネットを作成します

## アプリケーションロードバランサーの作成

次にアプリケーションロードバランサーを作成します。

### ec2 インスタンスの入っているパブリックサブネットをプライベートサブネットに変更する

ec2 のインスタンスへのアクセスはロードバランサーを介して行うようにします。
そのため、ec2 インスタンスが入っているパブリックサブネットをプライベートサブネットに変更します。
パブリックサブネットをプライベートサブネットに変更する方法は

1. サブネットの名前を変更する
   サブネットのページから`nozomi-dev-public-subnet1a`を`nozomi-dev-private-subnet1a`に変更します。
   ![](https://storage.googleapis.com/zenn-user-upload/32304a4f73f2-20230301.png)

2. パブリックサブネットのルートテーブルを変更する
   ルートテーブルは必要なくなるので、`nozomi-dev-private-subnet1a`のルートテーブルを削除します。

### ロードバランサーを入れるためのパブリックサブネットを作成する

ロードバランサーを作成するときに 2 つのサブネットを選択する必要があるので、新しく 2 つのサブネットを作成します。
前の記事で作成した`nozomi-dev-public-rtb`と作成したサブネットをひも付けます。

### セキュリティグループを作成する

アプリケーションロードバランサー用のセキュリティグループを作成します。
今回はインターネットからのアクセスを受け入れたいので `HTTP`と`HTTPS`のアクセスを許可します。
![](https://storage.googleapis.com/zenn-user-upload/b189ac6c5c84-20230302.png)

### アプリケーションロードバランサーを作成する

色々の準備が整ったので、本題のアプリケーションロードバランサーを作成します。
ネットワーキングマッピングと、セキュリティグループは前の工程で作成したものを選択します。
リスナーとルーティングはプロトコルを https にすると先程取得した TLS 証明を設定できるようになるので、
プロトコルを HTTPS にして、TLS 証明書を設定します。

### ec2 のセキュリティグループのインバウンドの設定を修正する

先程の記事で作成した ec2 のセキュリティグループのインバウンドルールをアプリケーションロードバランサーのみ受け入れるように修正します。
![](https://storage.googleapis.com/zenn-user-upload/8d22975ae534-20230306.png)

### Route53 のルーティング先を変更する

最後に Route53 のルーティング先を変更します。
トラフィックのルーティング先をアプリケーションロードバランサーに変更します。
レコードを編集から、エイリアスをオンにして、アプリケーションロードバランサーを選択します。
![](https://storage.googleapis.com/zenn-user-upload/690c387a2a98-20230306.png)
反映されるのに少し時間を待つ必要があります。

これで https 通信するための全ての作業が完了しました。
これで Route53 で作成したドメイン名にアクセスすると Apache のデフォルトページが表示されるはずです。
また、URL の先頭に`https://`がついていることを確認してください。
